# Applying `agentsec` To Skills (Step By Step)

This guide shows how to use `agentsec` as a supply-chain gate for skill packages before publishing them to agent runtimes.

Use this flow for any skill format (for example `SKILL.md`, `.mdc`, scripts, templates).

## What you get

- Signed skill artifacts
- Manifested permissions (AEM)
- Install-time policy enforcement
- Basic heuristic scan output for review

## Prerequisites

- `agentsec` built locally (`make build`)
- A skill directory to package
- A signing key for your environment (`agentsec keygen` for local/dev)

## 1) Define input variables

```bash
SKILL_DIR="./path/to/skill"
SKILL_ID="com.example.skill-name"
SKILL_VER="1.0.0"
OUT="./_dist/${SKILL_ID}-${SKILL_VER}"
mkdir -p "${OUT}"
```

## 2) Package the skill

```bash
./bin/agentsec package "${SKILL_DIR}" --out "${OUT}/skill.aext"
```

## 3) Create and validate an AEM manifest

```bash
./bin/agentsec manifest init "${SKILL_DIR}" \
  --id "${SKILL_ID}" \
  --type skill \
  --version "${SKILL_VER}" \
  --out "${OUT}/aem.json"

./bin/agentsec manifest validate "${OUT}/aem.json"
```

Then edit `${OUT}/aem.json` and set explicit permissions to match real runtime needs.

Secure defaults generated by `manifest init` are:

- `files.read=[]`
- `files.write=[]`
- `network.domains=[]`
- `network.allow_ip_literals=false`
- `process.allow_shell=false`
- `process.allow_subprocess=false`

## 4) Generate evidence artifacts

```bash
./bin/agentsec sbom "${OUT}/skill.aext" --out "${OUT}/sbom.spdx.json"
./bin/agentsec provenance "${OUT}/skill.aext" \
  --source-repo "https://github.com/your-org/your-skill-repo" \
  --source-rev "$(git rev-parse HEAD)" \
  --out "${OUT}/provenance.json"
./bin/agentsec scan "${OUT}/skill.aext" --out "${OUT}/scan.json"
```

Treat these outputs as scaffold/reference outputs today, not compliance-grade attestations.

## 5) Sign and verify

```bash
./bin/agentsec keygen --out "${OUT}/devkey.json"
./bin/agentsec sign "${OUT}/skill.aext" \
  --key "${OUT}/devkey.json" \
  --out "${OUT}/skill.sig.json"
./bin/agentsec verify "${OUT}/skill.aext" \
  --sig "${OUT}/skill.sig.json" \
  --pub "${OUT}/devkey.json"
```

For production, replace local dev-key handling with your managed signing workflow.

## 6) Enforce policy at install time

Create a policy (or start from `docs/policy.example.json`), then install:

```bash
./bin/agentsec install "${OUT}/skill.aext" \
  --sig "${OUT}/skill.sig.json" \
  --pub "${OUT}/devkey.json" \
  --aem "${OUT}/aem.json" \
  --policy "./docs/policy.example.json" \
  --dest "${OUT}/install"
```

`mode=enforce` fails closed on denied findings. `mode=warn` prints findings and continues.

## 7) Publish and promote

Publish this bundle together:

- `skill.aext`
- `aem.json`
- `skill.sig.json`
- `scan.json`
- `sbom.spdx.json`
- `provenance.json`

Consumer-side pattern:

1. Verify signature with a trusted key.
2. Evaluate policy against AEM.
3. Extract into a staging directory.
4. Promote staged files into the runtime's skill location only after checks pass.

## Platform mapping

The packaging/signature/policy flow is identical across runtimes. What changes is skill content format and final install location.

### Codex skills

- Package the skill folder that contains `SKILL.md` and resources.
- Gate publication with `agentsec` artifacts above.
- Promote verified/extracted skill files into your Codex skill path (commonly under `$CODEX_HOME/skills` in local workflows).

### Claude Code skills

- Package the skill folder (commonly a folder containing `SKILL.md` under `.claude/skills/...`).
- Apply the same sign/verify/policy workflow before sharing internally.
- Promote verified files into the target Claude skill path used by your team/repo.

### OpenClaw skills

- Package the OpenClaw skill folder (commonly `.mdc`-based skill content).
- Use the same manifest/sign/install policy gate.
- Note: current `agentsec scan` heuristics inspect `SKILL.md`, `.sh`, and `.ps1`; extend scanner rules if your skill corpus is primarily `.mdc`.

## CI/CD recommendation

In CI for every skill release:

1. Build skill artifact.
2. Validate manifest.
3. Run scan.
4. Sign artifact.
5. Verify signature.
6. Run policy-enforced install into a clean staging directory.
7. Publish release artifacts only if all checks pass.
