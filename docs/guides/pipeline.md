# Generic Pipeline

This guide covers the full `agentsec` supply-chain pipeline for any skill or extension format. Use this as a reference for the complete flow, or follow a [platform-specific guide](index.md) for a tailored walkthrough.

## What you get

- Signed skill artifacts
- Manifested permissions (AEM)
- Install-time policy enforcement
- Basic heuristic scan output for review

## Prerequisites

- Go 1.23+
- `agentsec` installed: `go install github.com/pjordan/agent-extension-security/cmd/agentsec@latest`
- A skill directory to package
- A signing key for your environment (`agentsec keygen` for local/dev)

## 1) Define input variables

```bash
SKILL_DIR="./path/to/skill"
SKILL_ID="com.example.skill-name"
SKILL_VER="1.0.0"
OUT="./_dist/${SKILL_ID}-${SKILL_VER}"
mkdir -p "${OUT}"
```

## 2) Package the skill

```bash
agentsec package "${SKILL_DIR}" --out "${OUT}/skill.aext"
```

## 3) Create and validate an AEM manifest

```bash
agentsec manifest init "${SKILL_DIR}" \
  --id "${SKILL_ID}" \
  --type skill \
  --version "${SKILL_VER}" \
  --out "${OUT}/aem.json"

agentsec manifest validate "${OUT}/aem.json"
```

Then edit `${OUT}/aem.json` and set explicit permissions to match real runtime needs.

Secure defaults generated by `manifest init` are:

- `files.read=[]`
- `files.write=[]`
- `network.domains=[]`
- `network.allow_ip_literals=false`
- `process.allow_shell=false`
- `process.allow_subprocess=false`

## 4) Generate evidence artifacts

```bash
agentsec sbom "${OUT}/skill.aext" --out "${OUT}/sbom.spdx.json"
agentsec provenance "${OUT}/skill.aext" \
  --source-repo "https://github.com/your-org/your-skill-repo" \
  --source-rev "$(git rev-parse HEAD)" \
  --out "${OUT}/provenance.json"
agentsec scan "${OUT}/skill.aext" --out "${OUT}/scan.json"
```

Treat these outputs as scaffold/reference outputs today, not compliance-grade attestations.

## 5) Sign and verify

```bash
agentsec keygen --out "${OUT}/devkey.json"
agentsec sign "${OUT}/skill.aext" \
  --key "${OUT}/devkey.json" \
  --out "${OUT}/skill.sig.json"
agentsec verify "${OUT}/skill.aext" \
  --sig "${OUT}/skill.sig.json" \
  --pub "${OUT}/devkey.json"
```

For production, replace local dev-key handling with your managed signing workflow.

## 6) Enforce policy at install time

Create a policy (or start from one of the [policy templates](../examples.md#policy-templates)), then install:

```bash
agentsec install "${OUT}/skill.aext" \
  --sig "${OUT}/skill.sig.json" \
  --pub "${OUT}/devkey.json" \
  --aem "${OUT}/aem.json" \
  --policy "./docs/policy.example.json" \
  --dest "${OUT}/install"
```

`mode=enforce` fails closed on denied findings. `mode=warn` prints findings and continues.

## 7) Publish and promote

Publish this bundle together:

- `skill.aext`
- `aem.json`
- `skill.sig.json`
- `scan.json`
- `sbom.spdx.json`
- `provenance.json`

Consumer-side pattern:

1. Verify signature with a trusted key.
2. Evaluate policy against AEM.
3. Extract into a staging directory.
4. Promote staged files into the runtime's skill location only after checks pass.

## CI/CD recommendation

In CI for every skill release:

1. Build skill artifact.
2. Validate manifest.
3. Run scan.
4. Sign artifact.
5. Verify signature.
6. Run policy-enforced install into a clean staging directory.
7. Publish release artifacts only if all checks pass.
